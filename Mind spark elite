import os
import datetime
import logging
from flask import Flask, request, jsonify
from flask_cors import CORS
import openai
# You would need 'google-auth' and 'google-api-python-client' for real IAP verification

app = Flask(__name__)
CORS(app)  # Allow frontend communication

# --- CONFIGURATION (Permanently Saved) ---
OPENAI_API_KEY = "YOUR_OPENAI_KEY_HERE"  # Add later
SUPPORT_EMAIL = "mindsparkelite6@gmail.com"
ADMIN_KEY = "MindSparkAdminSecret"

# Pricing Configuration
PRICING = {
    "NGN": {"monthly": 100000, "yearly": 1200000},
    "USD": {"monthly": 185, "yearly": 4995}
}

# --- 1. INFINITE ERROR CANCELLER & LOGGING ---
logging.basicConfig(filename='server_errors.log', level=logging.ERROR)

@app.errorhandler(Exception)
def infinite_error_eraser(e):
    """
    Catches ANY system crash, logs it, and prevents server shutdown.
    Auto-restarts the logic flow by returning a safe JSON response.
    """
    logging.error(f"CRITICAL ERROR CAUGHT: {str(e)}")
    # In a real scenario, this helps keep the container alive
    return jsonify({
        "status": "error", 
        "message": "System self-corrected. Please retry.",
        "support": SUPPORT_EMAIL
    }), 500

# --- 2. INFINITE BAD WORD FILTER (Smart Shield) ---
BAD_WORD_LIST = ["stupid", "idiot", "abuse", "vulgar1", "vulgar2"] # Expand this list

def smart_shield_filter(text):
    """
    Scans text for vulgarity. Blocks bad words but allows context.
    """
    clean_text = text.lower()
    for word in BAD_WORD_LIST:
        if word in clean_text:
            return True, "Message blocked by Smart Shield."
    return False, "Safe"

# --- 3. GOOGLE IN-APP PURCHASE VERIFICATION ---
@app.route('/verify-google-payment', methods=['POST'])
def verify_payment():
    """
    Receives the purchase token from the App (Frontend) and checks with Google.
    """
    data = request.json
    token = data.get('purchaseToken')
    sku = data.get('productId')
    
    # LOGIC:
    # 1. Connect to Google Play Developer API using service_account.json
    # 2. Call purchases.subscriptions.get(token)
    # 3. If subscriptionState == 1 (Active), grant access
    
    # Simulation for now:
    if token:
        return jsonify({"status": "success", "expiry": "2026-02-01", "plan": sku})
    else:
        return jsonify({"status": "failed"}), 400

# --- 4. AI PERSONALIZATION & EXAM LOGIC ---
@app.route('/get-exam-config', methods=['POST'])
def get_exam_config():
    """
    Returns exam timing based on Student Age/Grade.
    Junior = 20 mins, Senior = 40 mins.
    Includes the '3-Second' Logic breakdown.
    """
    data = request.json
    student_type = data.get('student_type') # 'junior' or 'senior'
    
    duration = 40 if student_type == 'senior' else 20
    
    return jsonify({
        "exam_duration_minutes": duration,
        "mode": "Exam Mode",
        "features": ["3-Step Logic", "Certificate on Completion"],
        "three_second_rule": {
            "step1": "1s - Rapid Recall",
            "step2": "1s - Processing",
            "step3": "1s - Answer Lock"
        }
    })

@app.route('/generate-certificate', methods=['POST'])
def generate_certificate():
    """
    Generates a certificate at the end of the month if exams are passed.
    """
    data = request.json
    name = data.get('name')
    score = data.get('score')
    
    if score > 70:
        return jsonify({"status": "awarded", "url": f"/certs/{name}_JAN2026.pdf"})
    return jsonify({"status": "try_again"})

# --- 5. FESTIVE DISCOUNT LOGIC ---
@app.route('/get-pricing', methods=['GET'])
def get_pricing():
    today = datetime.date.today()
    # Festive months: Dec (12), Jan (1), April (4)
    is_festive = today.month in [12, 1, 4]
    
    discount_rate = 0.90 if is_festive else 1.0
    
    return jsonify({
        "NGN": {
            "monthly": PRICING["NGN"]["monthly"] * discount_rate,
            "yearly": PRICING["NGN"]["yearly"] * discount_rate
        },
        "USD": {
            "monthly": PRICING["USD"]["monthly"] * discount_rate,
            "yearly": PRICING["USD"]["yearly"] * discount_rate
        },
        "is_festive_season": is_festive
    })

if __name__ == '__main__':
    # Render provides a PORT env var
    port = int(os.environ.get('PORT', 5000))
    app.run(host='0.0.0.0', port=port)
